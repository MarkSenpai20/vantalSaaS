<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SaaS File Transfer</title>
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        /* Mobile Viewport Fixes */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { background-color: #f8fafc; color: #0f172a; font-family: 'Inter', sans-serif; }
        
        /* Glass Effect Background */
        .bg-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        /* Gradient Mesh Background */
        .mesh-bg {
            background-color: #f3f4f6;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-size: 100% 100vh;
            background-repeat: no-repeat;
        }

        /* Hide Scrollbar but allow scroll */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Drag Overlay */
        #drag-overlay { transition: all 0.2s ease; opacity: 0; pointer-events: none; }
        body.dragging #drag-overlay { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body class="mesh-bg flex flex-col items-center justify-end md:justify-center p-0 md:p-6" 
      ondragover="event.preventDefault(); document.body.classList.add('dragging')" 
      ondragleave="document.body.classList.remove('dragging')" 
      ondrop="event.preventDefault(); document.body.classList.remove('dragging')">

    <!-- Drag & Drop Overlay -->
    <div id="drag-overlay" class="fixed inset-0 z-50 bg-blue-600/90 backdrop-blur-sm flex flex-col items-center justify-center text-white">
        <i class="ph ph-upload-simple text-7xl animate-bounce mb-4"></i>
        <h2 class="text-3xl font-bold tracking-tight">Drop files to send</h2>
    </div>

    <!-- Main Container -->
    <main class="w-full md:max-w-md bg-white md:rounded-3xl shadow-2xl overflow-hidden flex flex-col h-[100dvh] md:h-auto md:max-h-[85vh] transition-all duration-300">
        
        <!-- Header -->
        <header class="bg-slate-900 text-white p-6 pb-8 relative shrink-0">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-xl font-bold flex items-center gap-2">
                        <i class="ph-fill ph-paper-plane-tilt text-blue-400"></i> DropZone
                    </h1>
                    <p class="text-slate-400 text-sm mt-1">Secure P2P Transfer</p>
                </div>
                <!-- Status Badge -->
                <div id="status-badge" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-800 border border-slate-700 text-xs font-medium transition-colors">
                    <span id="status-dot" class="w-2 h-2 rounded-full bg-slate-500"></span>
                    <span id="status-text">Idle</span>
                </div>
            </div>
            
            <!-- Connection Wave Decoration -->
            <div class="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 opacity-50"></div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto scrollbar-hide bg-white relative">
            
            <!-- STEP 1: Connect -->
            <div id="step-connect" class="p-6 flex flex-col h-full animate-fade-in">
                <div class="flex-1 flex flex-col justify-center py-8">
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl mx-auto flex items-center justify-center mb-4 shadow-sm">
                            <i class="ph ph-link text-3xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-800">Connect to Admin</h2>
                        <p class="text-slate-500 mt-2 text-sm leading-relaxed">
                            Enter the unique receiver code provided by the administrator to start a secure tunnel.
                        </p>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 ml-1">Receiver Code</label>
                            <div class="relative">
                                <i class="ph ph-key absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-lg"></i>
                                <input type="text" id="admin-id-input" 
                                    class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-lg rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 block pl-11 p-4 outline-none transition-all placeholder-slate-400 font-medium" 
                                    placeholder="e.g. admin-code-01" 
                                    value="cnn-prints"
                                    autocomplete="off">
                            </div>
                        </div>
                        
                        <p id="error-msg" class="text-red-500 text-sm flex items-center gap-1 hidden bg-red-50 p-3 rounded-lg">
                            <i class="ph-fill ph-warning-circle"></i> <span>Error message</span>
                        </p>

                        <button onclick="connectToAdmin()" class="w-full bg-slate-900 hover:bg-slate-800 text-white rounded-xl p-4 font-bold text-lg shadow-lg shadow-slate-900/20 active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                            <span>Connect Securely</span>
                            <i class="ph-bold ph-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="mt-auto pt-6 text-center">
                    <p class="text-xs text-slate-400">End-to-end encrypted â€¢ Direct Peer Connection</p>
                </div>
            </div>

            <!-- STEP 2: Upload Interface (Hidden Initially) -->
            <div id="step-upload" class="hidden flex-col h-full relative">
                <!-- File Input / Dropzone -->
                <div class="p-6 pb-2 shrink-0">
                    <label class="group flex flex-col items-center justify-center w-full h-40 border-2 border-dashed border-blue-200 rounded-2xl cursor-pointer bg-blue-50/50 hover:bg-blue-50 hover:border-blue-400 transition-all active:scale-[0.99]">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6 text-center">
                            <div class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center text-blue-500 mb-3 group-hover:scale-110 transition-transform">
                                <i class="ph-duotone ph-cloud-arrow-up text-2xl"></i>
                            </div>
                            <p class="text-sm font-semibold text-slate-700">Tap to upload files</p>
                            <p class="text-xs text-slate-400 mt-1">or drag and drop here</p>
                        </div>
                        <input id="file-input" type="file" class="hidden" onchange="handleFileSelect(this.files)" multiple />
                    </label>
                </div>

                <!-- List Header -->
                <div class="px-6 py-2 flex justify-between items-end border-b border-slate-100 bg-white sticky top-0 z-10">
                    <h3 class="font-bold text-slate-800 text-lg">Transfers</h3>
                    <span id="queue-count" class="text-xs font-medium text-slate-400 bg-slate-100 px-2 py-1 rounded-md">0 items</span>
                </div>

                <!-- Transfer List -->
                <div id="transfer-list" class="flex-1 overflow-y-auto p-6 space-y-4 pb-20">
                    <!-- Empty State -->
                    <div id="empty-list" class="text-center py-10 opacity-50">
                        <i class="ph-duotone ph-ghost text-4xl text-slate-300 mb-2"></i>
                        <p class="text-sm text-slate-400">No files queued yet</p>
                    </div>
                    <!-- Items go here -->
                </div>
                
                <!-- Bottom Warning -->
                <div class="absolute bottom-0 w-full bg-white/90 backdrop-blur border-t border-slate-100 p-3 text-center z-20">
                    <p class="text-[10px] font-medium text-slate-400 flex items-center justify-center gap-1.5">
                        <i class="ph-fill ph-info text-blue-400"></i> Keep this tab open while sending
                    </p>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- Configuration ---
        const CHUNK_SIZE = 16 * 1024; // 16KB (Safe for all networks)
        
        // --- State ---
        let peer = null;
        let conn = null;
        let fileQueue = [];
        let isTransferring = false;
        let myId = null;

        // --- DOM Elements ---
        const stepConnect = document.getElementById('step-connect');
        const stepUpload = document.getElementById('step-upload');
        const adminInput = document.getElementById('admin-id-input');
        const statusBadge = document.getElementById('status-badge');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const errorMsg = document.getElementById('error-msg');
        const transferList = document.getElementById('transfer-list');
        const emptyList = document.getElementById('empty-list');
        const queueCount = document.getElementById('queue-count');

        // --- Initialization ---
        function initPeer() {
            peer = new Peer(null, {
                debug: 1,
                config: {
                    'iceServers': [
                        { url: 'stun:stun.l.google.com:19302' },
                        { url: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });

            peer.on('open', (id) => {
                myId = id;
                console.log('My ID:', id);
                updateConnectionUI('idle');
            });
            
            peer.on('error', (err) => {
                console.error(err);
                showError("Network initialization failed. Refresh page.");
            });
        }

        // --- Logic: Connection ---
        function connectToAdmin() {
            const adminId = adminInput.value.trim();
            if(!adminId) return showError("Please enter a Receiver Code.");
            
            errorMsg.classList.add('hidden');
            updateConnectionUI('connecting');

            // Attempt connection
            conn = peer.connect(adminId, { reliable: true });

            conn.on('open', () => {
                updateConnectionUI('connected');
                switchStep('upload');
            });

            conn.on('close', () => {
                updateConnectionUI('disconnected');
                switchStep('connect');
                showError("Connection lost. Please reconnect.");
            });

            conn.on('error', (err) => {
                console.error(err);
                updateConnectionUI('error');
                showError("Could not connect. Check the code.");
            });
            
            // Timeout failsafe
            setTimeout(() => {
                if(!conn.open) {
                    updateConnectionUI('idle');
                    showError("Connection timed out. Is Admin online?");
                }
            }, 5000);
        }

        // --- Logic: File Handling ---
        function handleFileSelect(files) {
            if (!conn || !conn.open) {
                showError("Disconnected. Please reconnect.");
                switchStep('connect');
                return;
            }
            
            if(files.length > 0) emptyList.classList.add('hidden');

            Array.from(files).forEach(file => {
                const fileId = Math.random().toString(36).substr(2, 9);
                
                // Add to UI
                const itemEl = createTransferItem(fileId, file.name, file.size);
                
                // Add to Queue
                fileQueue.push({
                    file: file,
                    id: fileId,
                    el: itemEl
                });
            });

            updateQueueCount();
            processQueue();
        }

        async function processQueue() {
            if (isTransferring || fileQueue.length === 0) return;
            
            isTransferring = true;
            const currentItem = fileQueue.shift();
            
            // Scroll to item
            currentItem.el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            try {
                await sendFile(currentItem);
            } catch (err) {
                console.error(err);
                markItemError(currentItem.el);
            }
            
            isTransferring = false;
            updateQueueCount();
            processQueue(); // Process next
        }

        async function sendFile(item) {
            const { file, id, el } = item;
            const progressBar = el.querySelector('.progress-bar');
            const statusLabel = el.querySelector('.status-label');
            const iconContainer = el.querySelector('.icon-container');
            
            // UI: Sending State
            statusLabel.innerHTML = `<span class="text-blue-500 font-semibold">Sending...</span>`;
            iconContainer.classList.add('animate-pulse');

            // 1. Send Header
            conn.send({
                type: 'header',
                fileId: id,
                name: file.name,
                size: file.size,
                mime: file.type
            });

            // 2. Send Chunks
            const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
            let offset = 0;

            for (let i = 0; i < totalChunks; i++) {
                if (!conn.open) throw new Error("Connection lost");

                const chunk = file.slice(offset, offset + CHUNK_SIZE);
                const arrayBuffer = await chunk.arrayBuffer();

                conn.send({
                    type: 'chunk',
                    fileId: id,
                    payload: arrayBuffer
                });

                offset += CHUNK_SIZE;
                
                // Update Progress (throttled)
                if (i % 5 === 0 || i === totalChunks - 1) {
                    const percent = Math.min(100, Math.round((offset / file.size) * 100));
                    progressBar.style.width = `${percent}%`;
                }

                // Vital: Breathe to prevent buffer overflow
                if (i % 30 === 0) await new Promise(r => setTimeout(r, 10));
            }

            // 3. Send End
            conn.send({ type: 'end', fileId: id });

            // UI: Success State
            statusLabel.innerHTML = `<span class="text-green-600 font-bold flex items-center gap-1"><i class="ph-bold ph-check"></i> Sent</span>`;
            progressBar.classList.replace('bg-blue-500', 'bg-green-500');
            iconContainer.classList.remove('animate-pulse');
            iconContainer.classList.replace('bg-blue-50', 'bg-green-50');
            iconContainer.innerHTML = `<i class="ph-fill ph-check-circle text-green-500 text-xl"></i>`;
        }

        // --- UI Helper Functions ---
        function switchStep(step) {
            if(step === 'upload') {
                stepConnect.classList.add('hidden');
                stepUpload.classList.remove('hidden');
                stepUpload.classList.add('flex');
                stepUpload.classList.add('animate-slide-up');
            } else {
                stepUpload.classList.add('hidden');
                stepUpload.classList.remove('flex');
                stepConnect.classList.remove('hidden');
                stepConnect.classList.add('animate-fade-in');
            }
        }

        function createTransferItem(id, name, size) {
            const div = document.createElement('div');
            div.id = `item-${id}`;
            div.className = "bg-white border border-slate-100 rounded-xl p-3 shadow-sm hover:shadow-md transition-all flex items-center gap-4 animate-slide-up";
            div.innerHTML = `
                <div class="icon-container w-10 h-10 rounded-lg bg-blue-50 text-blue-500 flex items-center justify-center shrink-0 transition-colors">
                    <i class="ph-fill ph-file text-xl"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-center mb-1.5">
                        <span class="text-sm font-semibold text-slate-700 truncate pr-2" title="${name}">${name}</span>
                        <span class="text-[10px] status-label text-slate-400 font-medium whitespace-nowrap">Queued</span>
                    </div>
                    <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                        <div class="progress-bar h-full bg-blue-500 w-0 transition-all duration-200 ease-out"></div>
                    </div>
                    <div class="mt-1 flex justify-between">
                         <span class="text-[10px] text-slate-400">${formatBytes(size)}</span>
                    </div>
                </div>
            `;
            transferList.prepend(div);
            return div;
        }

        function markItemError(el) {
            const statusLabel = el.querySelector('.status-label');
            const progressBar = el.querySelector('.progress-bar');
            statusLabel.innerHTML = `<span class="text-red-500 font-bold">Failed</span>`;
            progressBar.classList.replace('bg-blue-500', 'bg-red-500');
            progressBar.style.width = '100%';
        }

        function updateConnectionUI(state) {
            const colors = {
                idle: 'bg-slate-500',
                connecting: 'bg-yellow-500',
                connected: 'bg-green-500',
                disconnected: 'bg-red-500',
                error: 'bg-red-500'
            };
            
            // Reset animations
            statusDot.className = `w-2 h-2 rounded-full transition-all ${colors[state] || 'bg-slate-500'}`;
            statusBadge.className = `flex items-center gap-2 px-3 py-1.5 rounded-full border text-xs font-medium transition-colors ${state === 'connected' ? 'bg-green-50 border-green-200 text-green-700' : 'bg-slate-800 border-slate-700 text-slate-300'}`;
            
            if(state === 'connecting') statusDot.classList.add('animate-ping');
            if(state === 'connected') statusDot.classList.add('shadow-[0_0_8px_rgba(34,197,94,0.6)]');

            const texts = {
                idle: 'Idle',
                connecting: 'Connecting...',
                connected: 'Secured',
                disconnected: 'Offline',
                error: 'Error'
            };
            statusText.innerText = texts[state];
        }

        function updateQueueCount() {
            const count = fileQueue.length;
            queueCount.innerText = count > 0 ? `${count} queued` : 'Ready';
        }

        function showError(msg) {
            errorMsg.querySelector('span').innerText = msg;
            errorMsg.classList.remove('hidden');
            setTimeout(() => errorMsg.classList.add('hidden'), 5000); // Auto hide
        }

        function formatBytes(bytes, decimals = 1) {
            if (!+bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(decimals))} ${sizes[i]}`;
        }
        
        // --- Drag & Drop Global ---
        document.body.addEventListener('drop', (e) => {
            e.preventDefault();
            if(stepUpload.classList.contains('hidden')) return; // Only allow drop in upload step
            if(e.dataTransfer.files.length) handleFileSelect(e.dataTransfer.files);
        });

        // Start
        initPeer();

    </script>
</body>
</html>


